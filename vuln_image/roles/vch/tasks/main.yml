---
- name: Install dotnet repo keys
  apt:
    deb: https://packages.microsoft.com/config/ubuntu/18.04/packages-microsoft-prod.deb

- name: Install .NET Core 2.1 and MongoDB and NTP server
  apt:
    name:
     - dotnet-sdk-2.1
     - mongodb
     - ntp
    state: latest
    update_cache: yes

- name: Create user
  user:
    name: vch
    createhome: yes
    system: yes
    groups: mongodb
    append: yes
    shell: /usr/sbin/nologin

- name: Copy sources
  copy:
    src: '../services/Vch/{{ item }}'
    dest: /home/vch/
    owner: vch
    group: vch
    mode: u=rwX,g=,o=
  with_items:
    - 'NTPTools'
    - 'VchAPI'
    - 'Vch.Core'
  notify: restart vch service

- name: Build service
  become_user: vch
  shell: |
      dotnet build -c Release
  args:
    chdir: /home/vch/VchAPI/
  notify: restart vch service

- name: Install systemd units
  copy:
    src: '{{ item }}'
    dest: '/etc/systemd/system/{{ item }}'
  notify: restart vch service
  with_items:
    - vch.service
    - mongodb.service

- name: Enable services
  systemd:
    name: '{{ item }}'
    enabled: yes
    state: restarted
    daemon_reload: yes
  with_items:
    - vch
    - mongodb

